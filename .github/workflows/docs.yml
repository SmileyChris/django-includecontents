name: Deploy Documentation

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
    paths:
      - 'docs/**'
      - 'mkdocs.yml'
      - '.github/workflows/docs.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'docs/**'
      - 'mkdocs.yml'
      - '.github/workflows/docs.yml'
  release:
    types: [ published ]
  workflow_dispatch:
    inputs:
      version_tag:
        description: 'Version tag to deploy (e.g., v3.2.0)'
        required: false

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "docs-${{ github.ref }}"
  cancel-in-progress: false

jobs:
  deploy-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[docs]"

      - name: Configure Git user
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      # Build and test on pull requests
      - name: Build documentation (PR)
        if: github.event_name == 'pull_request'
        run: mkdocs build --clean --strict

      # Deploy dev docs from main branch
      - name: Deploy dev docs (main)
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          mike deploy dev --push --update-aliases

      # Deploy versioned docs from tags
      - name: Extract version from tag
        if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'release' && startsWith(github.event.release.tag_name, 'v')) || github.event_name == 'workflow_dispatch'
        id: extract_version
        env:
          TAG_REF: ${{ github.ref }}
          RELEASE_TAG: ${{ github.event.release.tag_name || '' }}
          VERSION_INPUT: ${{ github.event.inputs.version_tag || '' }}
        run: |
          git fetch --tags --force
          if [ "${GITHUB_EVENT_NAME}" = "release" ]; then
            FULL_TAG=${RELEASE_TAG}
          elif [ "${GITHUB_EVENT_NAME}" = "workflow_dispatch" ]; then
            if [ -n "${VERSION_INPUT}" ]; then
              if [[ "${VERSION_INPUT}" != v* ]]; then
                echo "version_tag must start with v (e.g., v3.2.0)" >&2
                exit 1
              fi
              FULL_TAG=${VERSION_INPUT}
            else
              FULL_TAG=$(git tag -l 'v*' | sort -V | tail -1)
              if [ -z "${FULL_TAG}" ]; then
                echo "No tags found matching pattern v*" >&2
                exit 1
              fi
              echo "No version_tag provided. Using latest tag ${FULL_TAG}"
            fi
          else
            FULL_TAG=${TAG_REF#refs/tags/}
          fi
          if [ -z "${FULL_TAG}" ]; then
            echo "Unable to determine tag for deployment" >&2
            exit 1
          fi
          TAG=${FULL_TAG#v}
          # Extract major.minor version (e.g., 3.1.1 -> 3.1)
          VERSION=$(echo $TAG | sed -E 's/^([0-9]+\.[0-9]+).*/\1/')
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "FULL_TAG=$FULL_TAG" >> $GITHUB_OUTPUT
          echo "Deploying documentation for version $VERSION from tag $FULL_TAG"

      - name: Deploy versioned docs (tag)
        if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'release' && startsWith(github.event.release.tag_name, 'v')) || github.event_name == 'workflow_dispatch'
        env:
          TAG_REF: ${{ github.ref }}
          RELEASE_TAG: ${{ github.event.release.tag_name || '' }}
          VERSION_INPUT: ${{ github.event.inputs.version_tag || '' }}
          EXTRACTED_TAG: ${{ steps.extract_version.outputs.FULL_TAG || '' }}
        run: |
          VERSION=${{ steps.extract_version.outputs.VERSION }}
          if [ -z "${VERSION}" ]; then
            echo "Version output missing. Skipping deployment." >&2
            exit 1
          fi
          git fetch --tags --force
          # Check if this is the latest version by comparing with other tags
          LATEST_TAG=$(git tag -l 'v*' | sort -V | tail -1)
          if [ "${GITHUB_EVENT_NAME}" = "release" ]; then
            CURRENT_TAG=${RELEASE_TAG}
          elif [ "${GITHUB_EVENT_NAME}" = "workflow_dispatch" ]; then
            if [ -n "${VERSION_INPUT}" ]; then
              CURRENT_TAG=${VERSION_INPUT}
            else
              CURRENT_TAG=${EXTRACTED_TAG}
            fi
          else
            CURRENT_TAG=${TAG_REF#refs/tags/}
          fi
          if [ -z "${CURRENT_TAG}" ]; then
            echo "Unable to determine tag to deploy" >&2
            exit 1
          fi

          if [ "$CURRENT_TAG" = "$LATEST_TAG" ]; then
            echo "This is the latest version, updating latest alias"
            mike deploy $VERSION latest --push --update-aliases
          else
            echo "Not the latest version, deploying without latest alias"
            mike deploy $VERSION --push --update-aliases
          fi
