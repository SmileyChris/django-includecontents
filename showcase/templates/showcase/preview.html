<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Component Preview</title>
    {% load static %}

    <!-- Base styles for preview iframe -->
    <style>
      body {
        margin: 0;
        padding: 1rem;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        line-height: 1.6;
        color: #333;
        background: #fff;
      }

      /* Reset some basic elements to prevent interference */
      * {
        box-sizing: border-box;
      }

      /* Responsive helpers */
      img {
        max-width: 100%;
        height: auto;
      }

      /* Error styling */
      .preview-error {
        padding: 1rem;
        background: #fee2e2;
        border: 1px solid #fecaca;
        border-radius: 0.375rem;
        color: #dc2626;
      }
    </style>

    {% comment %}
      > Override this template to include your project's CSS files:
      {% extends "showcase/preview.html" %}
      {% block styles %}
        {{ block.super }}
        <link rel="stylesheet" href="{% static 'css/your-styles.css' %}" />
      {% endblock %}
    {% endcomment %}
    {% block styles %}
    {% endblock %}
  </head>
  <body>
    {% block content %}
      <div id="component-container">
        {% if error %}
          <div class="preview-error"><strong>Error:</strong> {{ error }}</div>
        {% else %}
          {{ component_html|safe }}
        {% endif %}
      </div>
    {% endblock content %}

    {% block scripts %}
      <script>
        (function() {
          'use strict';

          // Auto-resize iframe to content height
          function updateParentHeight() {
            // Force document to reset its height constraints
            document.documentElement.style.height = 'auto';
            document.body.style.height = 'auto';

            // Force reflow
            document.documentElement.offsetHeight;

            // Get the actual rendered content height using bounding rect
            const container = document.getElementById('component-container');
            if (container) {
              const rect = container.getBoundingClientRect();
              // Add body padding (2rem = 32px typically)
              const bodyStyles = window.getComputedStyle(document.body);
              const paddingTop = parseFloat(bodyStyles.paddingTop) || 0;
              const paddingBottom = parseFloat(bodyStyles.paddingBottom) || 0;
              const height = Math.ceil(rect.height + paddingTop + paddingBottom);

              // Send height to parent window
              if (window.parent && window.parent !== window) {
                window.parent.postMessage(
                  {
                    type: "resize",
                    height: height,
                  },
                  "*",
                );
              }
            } else {
              // Fallback to body measurement, but avoid scrollHeight
              const height = document.body.offsetHeight;
              if (window.parent && window.parent !== window) {
                window.parent.postMessage(
                  {
                    type: "resize",
                    height: height,
                  },
                  "*",
                );
              }
            }
          }

          // Update height when content changes
          document.addEventListener("DOMContentLoaded", updateParentHeight);
          window.addEventListener("resize", updateParentHeight);

          // Use MutationObserver to detect content changes
          if (window.MutationObserver) {
            const observer = new MutationObserver(updateParentHeight);
            observer.observe(document.body, {
              childList: true,
              subtree: true,
              attributes: true,
            });
          }

          // Listen for height recalculation requests from parent
          window.addEventListener('message', function(event) {
            if (event.data.type === 'recalculate-height') {
              // Force recalculation after a brief delay to ensure layout is complete
              setTimeout(updateParentHeight, 10);
            }
          });
        })();
      </script>
    {% endblock scripts %}
  </body>
</html>
